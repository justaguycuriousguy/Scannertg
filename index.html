<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Monster Scanner Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        /* Your existing styles */
    </style>
</head>
<body>
    <h1>Monster Scanner</h1>
    <div id="scanner-container">
        <div class="scanner-overlay"></div>
        <div class="red-filter"></div>
        <div id="scanning-indicator">Scanning for Monsters...</div>
    </div>
    <div id="result">Press Start to begin monster hunt!</div>
    <button id="startButton">Start Monster Hunt</button>

    <script>
        let tg = window.Telegram.WebApp;
        tg.expand();

        const resultElement = document.getElementById('result');
        const startButton = document.getElementById('startButton');
        const scanningIndicator = document.getElementById('scanning-indicator');
        const redFilter = document.querySelector('.red-filter');
        let scanning = false;
        let scannedBarcode = null;

        function initQuagga() {
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'),
                    constraints: {
                        facingMode: "environment",
                    },
                },
                decoder: {
                    readers: ["ean_reader", "ean_8_reader", "code_128_reader", "code_39_reader", "upc_reader", "upc_e_reader"]
                }
            }, function(err) {
                if (err) {
                    console.error("Quagga initialization failed", err);
                    resultElement.textContent = 'Error initializing scanner: ' + err;
                    scanning = false;
                    startButton.textContent = 'Retry Monster Hunt';
                    scanningIndicator.style.display = 'none';
                    redFilter.style.display = 'none';
                    return;
                }
                Quagga.start();
                scanning = true;
                startButton.textContent = 'Stop Monster Hunt';
                scanningIndicator.style.display = 'block';
                redFilter.style.display = 'block';
            });

            Quagga.onDetected(function(result) {
                if (result.codeResult.code) {
                    handleMonsterScan(result.codeResult.code);
                }
            });
        }

        function handleMonsterScan(barcode) {
            scannedBarcode = barcode;
            resultElement.textContent = 'Barcode scanned! Sending data to the bot...';

            if (scanning) {
                Quagga.stop();
                scanning = false;
                startButton.textContent = 'Start New Hunt';
                scanningIndicator.style.display = 'none';
                redFilter.style.display = 'none';
            }

            sendBarcodeToBot();
        }

        function sendBarcodeToBot() {
            if (scannedBarcode) {
                const data = {
                    action: 'scan',
                    barcode: scannedBarcode
                };

                console.log('Sending data to bot:', data);

                tg.sendData(JSON.stringify(data));

                resultElement.textContent = 'Data sent to the bot. Check your chat for the response.';
            } else {
                resultElement.textContent = 'No barcode scanned yet. Please scan an item.';
            }
        }

        function toggleScanning() {
            if (scanning) {
                Quagga.stop();
                scanning = false;
                startButton.textContent = 'Start Monster Hunt';
                resultElement.textContent = 'Monster hunt paused';
                scanningIndicator.style.display = 'none';
                redFilter.style.display = 'none';
            } else {
                startButton.disabled = true;
                startButton.textContent = 'Activating Scanner...';

                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                    .then(function(stream) {
                        stream.getTracks().forEach(track => track.stop());
                        initQuagga();
                        startButton.disabled = false;
                    })
                    .catch(function(err) {
                        console.error("An error occurred: " + err);
                        resultElement.textContent = 'Camera access denied. Please grant permission and try again.';
                        startButton.textContent = 'Retry Monster Hunt';
                        startButton.disabled = false;
                    });
            }
        }

        startButton.addEventListener('click', toggleScanning);

        resultElement.textContent = 'Monster detector ready. Press Start to begin your hunt!';
    </script>
</body>
</html>

